<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intercom Dashboard</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –¥–æ–º–æ—Ñ–æ–Ω–æ–≤ */
        .intercoms-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .intercoms-table th,
        .intercoms-table td {
            border: 1px solid #e0e0e0;
            padding: 14px 16px;
            text-align: left;
        }

        .intercoms-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .intercoms-table tr:hover {
            background-color: #f8f9fa;
        }

        .intercoms-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* –°—Ç–∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ */
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-online {
            background-color: #28a745;
            color: white;
        }

        .status-offline {
            background-color: #dc3545;
            color: white;
        }

        .status-unknown {
            background-color: #ffc107;
            color: #333;
        }

        /* –°—Ç–∏–ª–∏ –¥–≤–µ—Ä–∏ */
        .door-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .door-open {
            background-color: #28a745;
            color: white;
        }

        .door-closed {
            background-color: #6c757d;
            color: white;
        }

        .door-unknown {
            background-color: #ffc107;
            color: #333;
        }

        .door-ringing {
            background-color: #ffc107;
            color: #333;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-open {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-open:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-open:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-open:disabled:hover {
            transform: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π */
        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .events-table th,
        .events-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
        }

        .events-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .events-table tr:hover {
            background-color: #f5f5f5;
        }

        .events-table tr.table-warning {
            background-color: #fff3cd !important;
        }

        .events-table tr.table-success {
            background-color: #d4edda !important;
        }

        .events-table tr.table-info {
            background-color: #d1ecf1 !important;
        }

        .event-icon {
            margin-right: 5px;
            font-size: 1.2em;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #e0e0e0;
            margin-top: 20px;
        }

        /* –í—Ä–µ–º—è */
        .timestamp {
            font-family: 'Courier New', monospace;
            color: #666;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            header h1 {
                font-size: 1.8em;
            }

            .intercoms-table, .events-table {
                font-size: 0.9em;
            }

            .intercoms-table th,
            .intercoms-table td,
            .events-table th,
            .events-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Intercom Dashboard</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–æ—Ñ–æ–Ω–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </header>

        <div class="content">
            <h2>üìä –°–ø–∏—Å–æ–∫ –¥–æ–º–æ—Ñ–æ–Ω–æ–≤</h2>
            <table class="intercoms-table">
                <thead>
                    <tr>
                        <th>MAC –∞–¥—Ä–µ—Å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–≤–µ—Ä—å</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="intercom-table">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #667eea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="margin-left: 10px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h2>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
            <table class="events-table">
                <thead>
                    <tr>
                        <th>–í—Ä–µ–º—è</th>
                        <th>MAC –¥–æ–º–æ—Ñ–æ–Ω–∞</th>
                        <th>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                        <th>–ö–≤–∞—Ä—Ç–∏—Ä–∞</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                    </tr>
                </thead>
                <tbody id="events-table">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #667eea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="margin-left: 10px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <footer>
            <p>¬© 2026 Intercom System | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 3-5 —Å–µ–∫—É–Ω–¥</p>
        </footer>
    </div>

    <script>
        // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        // @keyframes spin {
        //     0% { transform: rotate(0deg); }
        //     100% { transform: rotate(360deg); }
        // }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π (—Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è)
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–º–æ—Ñ–æ–Ω–æ–≤
        async function fetchIntercoms() {
            try {
                const res = await fetch('/api/intercoms');
                const data = await res.json();
                const tbody = document.getElementById('intercom-table');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–º–æ—Ñ–æ–Ω–æ–≤</td></tr>';
                    return;
                }

                data.forEach(i => {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    const statusClass = i.status === 'online' ? 'status-online' : 'status-offline';
                    const statusText = i.status === 'online' ? '‚úÖ Online' : '‚ùå Offline';

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–≤–µ—Ä–∏
                    let doorClass = 'door-unknown';
                    let doorText = i.door_status || 'Unknown';

                    if (i.door_status === 'open') {
                        doorClass = 'door-open';
                        doorText = 'üö™ –û—Ç–∫—Ä—ã—Ç–∞';
                    } else if (i.door_status === 'closed') {
                        doorClass = 'door-closed';
                        doorText = 'üîí –ó–∞–∫—Ä—ã—Ç–∞';
                    } else if (i.door_status === 'ringing') {
                        doorClass = 'door-ringing';
                        doorText = 'üîî –ó–≤–æ–Ω–æ–∫';
                    } else {
                        doorText = '‚ùì ' + i.door_status;
                    }

                    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è (–æ—Ç–∫–ª—é—á–µ–Ω–∞ –µ—Å–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω)
                    const isOnline = i.status === 'online';
                    const btnDisabled = !isOnline ? 'disabled' : '';
                    const btnTitle = isOnline ? '–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å' : '–î–æ–º–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    const btnStyle = isOnline ? '' : 'opacity: 0.5; cursor: not-allowed;';

                    tbody.innerHTML += `
                        <tr>
                            <td><code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${i.mac}</code></td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                            <td><span class="door-status ${doorClass}">${doorText}</span></td>
                            <td class="timestamp">${formatDateTime(i.last_seen)}</td>
                            <td>
                                <button
                                    class="btn btn-open"
                                    onclick="openDoor('${i.mac}')"
                                    ${btnDisabled}
                                    title="${btnTitle}"
                                    style="${btnStyle}"
                                >
                                    üö™ –û—Ç–∫—Ä—ã—Ç—å
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (err) {
                console.error('Error fetching intercoms:', err);
                document.getElementById('intercom-table').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                        </td>
                    </tr>
                `;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏
        async function openDoor(mac) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å –¥–æ–º–æ—Ñ–æ–Ω–∞ ${mac}?`)) {
                return;
            }

            try {
                const res = await fetch(`/open/${mac}`, { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    alert(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ${mac}`);
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (err) {
                console.error('Error opening door:', err);
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        async function loadEvents() {
            try {
                const response = await fetch('/api/events?limit=20');
                const events = await response.json();

                const tbody = document.getElementById('events-table');
                tbody.innerHTML = events.map(e => {
                    // –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
                    const icons = {
                        'heartbeat': 'üíì',
                        'call': 'üîî',
                        'key': 'üîë',
                        'door_opened': 'üö™',
                        'open_command': 'üì±'
                    };
                    const icon = icons[e.event_type] || '‚ÑπÔ∏è';

                    // –î–µ—Ç–∞–ª–∏ –∏–∑ payload
                    let details = '';
                    try {
                        const payload = e.payload ? JSON.parse(e.payload) : {};
                        if (e.event_type === 'key') {
                            details = `–ö–ª—é—á: ${payload.key_id || 'N/A'}`;
                        } else if (e.event_type === 'door_opened') {
                            details = `–ò—Å—Ç–æ—á–Ω–∏–∫: ${payload.source || 'N/A'}`;
                        } else if (e.event_type === 'call') {
                            details = `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${e.apartment || 'N/A'}`;
                        } else if (e.event_type === 'open_command') {
                            details = `–£–¥–∞–ª—ë–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞`;
                        } else {
                            details = JSON.stringify(payload);
                        }
                    } catch (err) {
                        details = e.payload || '-';
                    }

                    // –¶–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                    let rowClass = '';
                    if (e.event_type === 'call') rowClass = 'table-warning';
                    if (e.event_type === 'door_opened') rowClass = 'table-success';
                    if (e.event_type === 'key') rowClass = 'table-info';

                    return `
                        <tr class="${rowClass}">
                            <td class="timestamp">${formatTime(e.created_at)}</td>
                            <td><code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${e.intercom_mac}</code></td>
                            <td><strong><span class="event-icon">${icon}</span>${e.event_type}</strong></td>
                            <td>${e.apartment || '-'}</td>
                            <td>${details}</td>
                        </tr>
                    `;
                }).join('');

                if (events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</td></tr>';
                }
            } catch (err) {
                console.error('Error loading events:', err);
                document.getElementById('events-table').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π
                        </td>
                    </tr>
                `;
            }
        }

        // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        fetchIntercoms();
        loadEvents();

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        setInterval(fetchIntercoms, 5000);
        setInterval(loadEvents, 3000);
    </script>
</body>
</html>